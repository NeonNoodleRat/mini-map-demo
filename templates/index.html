<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Property Map: Texas Oil & Gas Properties</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
 <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>

<script id="search-js" defer src="https://api.mapbox.com/search-js/v1.3.0/web.js"></script>

</head>
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet"/>

<body>
    <div id="map"></div>

    <div class="places">
      <h3>View by County: </h3>
      <ul id="county-buttons">
        <!-- County buttons will be dynamically generated -->
      </ul>
    </div>

<script>
    const ACCESS_TOKEN = "{{ access_token }}";
    
    mapboxgl.accessToken = ACCESS_TOKEN;

    // Center the map on Texas
    const map = new mapboxgl.Map( {
        container: 'map',
        center: [-99.9018, 31.9686], // Center of Texas
        zoom: 6,
        config: {
            basemap: {
                lightPreset: "night",
                theme: 'monochrome'
            }
        },
    })

    let propertyData = [];
    let markers = [];

    // Fetch property data from API
    async function loadPropertyData() {
        try {
            const response = await fetch('/api/properties');
            propertyData = await response.json();
            console.log(`Loaded ${propertyData.length} properties`);
            
            buildCountyButtons();
            addMarkersToMap();
        } catch (error) {
            console.error('Error loading property data:', error);
        }
    }

    function buildCountyButtons() {
        // Get unique counties from the data
        const counties = [...new Set(propertyData
            .filter(property => property.county && property.county.trim())
            .map(property => property.county.trim())
        )].sort();
        
        const buttonContainer = document.getElementById('county-buttons');
        buttonContainer.innerHTML = '';
        
        // Add "Show All" button first
        const allButton = document.createElement('li');
        allButton.innerHTML = '<button id="all">Show All</button>';
        buttonContainer.appendChild(allButton);
        
        // Add button for each county
        counties.forEach(county => {
            const li = document.createElement('li');
            const buttonId = county.toLowerCase().replace(/\s+/g, '-');
            li.innerHTML = `<button id="${buttonId}">${county}</button>`;
            buttonContainer.appendChild(li);
        });
        
        // Add event listeners to new buttons
        addButtonEventListeners();
    }

    function addButtonEventListeners() {
        const buttons = document.querySelectorAll('#county-buttons button');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.id === 'all') {
                    filterByCounty('all');
                } else {
                    // Find the county name from the button text
                    const countyName = button.textContent;
                    filterByCounty(countyName);
                }
            });
        });
    }

    function addMarkersToMap() {
        // Clear existing markers
        markers.forEach(marker => marker.remove());
        markers = [];

        propertyData.forEach(property => {
            if (!property.longitude || !property.latitude) return;

            const el = document.createElement('div');
            el.className = 'marker property-marker';

            // Create popup content
            const popupContent = `
                <div class="property-popup">
                    <h3>${property.owner_name || 'Unknown Owner'}</h3>
                    <div class="property-details">
                        <p><strong>Address:</strong> ${formatAddress(property)}</p>
                        <p><strong>County:</strong> ${property.county || 'Unknown'}</p>
                        ${property.operator ? `<p><strong>Operator:</strong> ${property.operator}</p>` : ''}
                        ${property.well_name ? `<p><strong>Well:</strong> ${property.well_name}</p>` : ''}
                        ${property.property_description ? `<p class="property-desc"><strong>Description:</strong> ${property.property_description.substring(0, 100)}${property.property_description.length > 100 ? '...' : ''}</p>` : ''}
                    </div>
                </div>
            `;

            const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(popupContent);

            const marker = new mapboxgl.Marker(el)
                .setLngLat([property.longitude, property.latitude])
                .setPopup(popup)
                .addTo(map);

            markers.push(marker);
        });
    }

    function formatAddress(property) {
        const parts = [];
        if (property.owner_address) parts.push(property.owner_address);
        if (property.city) parts.push(property.city);
        if (property.state) parts.push(property.state);
        if (property.zip) parts.push(property.zip);
        return parts.join(', ') || 'Address not available';
    }

    // County filter functionality
    function filterByCounty(county) {
        markers.forEach(marker => marker.remove());
        markers = [];

        const filteredData = county === 'all' 
            ? propertyData 
            : propertyData.filter(property => 
                property.county && property.county.trim() === county
            );

        filteredData.forEach(property => {
            if (!property.longitude || !property.latitude) return;

            const el = document.createElement('div');
            el.className = 'marker property-marker';

            const popupContent = `
                <div class="property-popup">
                    <h3>${property.owner_name || 'Unknown Owner'}</h3>
                    <div class="property-details">
                        <p><strong>Address:</strong> ${formatAddress(property)}</p>
                        <p><strong>County:</strong> ${property.county || 'Unknown'}</p>
                        ${property.operator ? `<p><strong>Operator:</strong> ${property.operator}</p>` : ''}
                        ${property.well_name ? `<p><strong>Well:</strong> ${property.well_name}</p>` : ''}
                    </div>
                </div>
            `;

            const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(popupContent);

            const marker = new mapboxgl.Marker(el)
                .setLngLat([property.longitude, property.latitude])
                .setPopup(popup)
                .addTo(map);

            markers.push(marker);
        });

        // Fit map to show filtered markers
        if (markers.length > 0) {
            const bounds = new mapboxgl.LngLatBounds();
            markers.forEach(marker => bounds.extend(marker.getLngLat()));
            map.fitBounds(bounds, { padding: 50 });
        }
    }

    // Load data when page loads
    map.on('load', () => {
        loadPropertyData();
    });
  
    // Add search functionality
    window.addEventListener('load', () => {
        const searchBox = new MapboxSearchBox();
        searchBox.accessToken = ACCESS_TOKEN;
        searchBox.marker = true;
        searchBox.mapboxgl = mapboxgl;
        searchBox.componentOptions = { allowReverse: true, flipCoordinates: true };
        map.addControl(searchBox);
    });

</script>

</body>
</html>