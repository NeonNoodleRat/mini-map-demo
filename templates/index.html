<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Property Map: Texas Oil & Gas Properties</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
 <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>

<script id="search-js" defer src="https://api.mapbox.com/search-js/v1.3.0/web.js"></script>

</head>
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet"/>

<body>
    <div id="map"></div>

    <div class="places">
      <h3>View by County: </h3>
      <ul id="county-buttons">
        <!-- County buttons will be dynamically generated -->
      </ul>
    </div>

<script>
    const ACCESS_TOKEN = "{{ access_token }}";
    
    mapboxgl.accessToken = ACCESS_TOKEN;

    // Center the map on Texas
    const map = new mapboxgl.Map( {
        container: 'map',
        style: 'mapbox://styles/mapbox/standard',
        center: [-99.9018, 31.9686], // Center of Texas
        zoom: 6
    })

    let propertyData = [];

    // Fetch property data from API
    async function loadPropertyData() {
        try {
            const response = await fetch('/api/properties');
            propertyData = await response.json();
            console.log(`Loaded ${propertyData.length} properties`);
            
            buildCountyButtons();
            addDataToMap();
        } catch (error) {
            console.error('Error loading property data:', error);
        }
    }

    function buildCountyButtons() {
        // Get unique counties from the data
        const counties = [...new Set(propertyData
            .filter(property => property.county && property.county.trim())
            .map(property => property.county.trim())
        )].sort();
        
        const buttonContainer = document.getElementById('county-buttons');
        buttonContainer.innerHTML = '';
        
        // Add "Show All" button first
        const allButton = document.createElement('li');
        allButton.innerHTML = '<button id="all">Show All</button>';
        buttonContainer.appendChild(allButton);
        
        // Add button for each county
        counties.forEach(county => {
            const li = document.createElement('li');
            const buttonId = county.toLowerCase().replace(/\s+/g, '-');
            li.innerHTML = `<button id="${buttonId}">${county}</button>`;
            buttonContainer.appendChild(li);
        });
        
        // Add event listeners to new buttons
        addButtonEventListeners();
    }

    function addButtonEventListeners() {
        const buttons = document.querySelectorAll('#county-buttons button');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.id === 'all') {
                    filterByCounty('all');
                } else {
                    // Find the county name from the button text
                    const countyName = button.textContent;
                    filterByCounty(countyName);
                }
            });
        });
    }

    function convertToGeoJSON(data) {
        return {
            "type": "FeatureCollection",
            "features": data
                .filter(property => property.longitude && property.latitude)
                .map(property => ({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [property.longitude, property.latitude]
                    },
                    "properties": {
                        "owner_name": property.owner_name || 'Unknown Owner',
                        "owner_address": property.owner_address || '',
                        "city": property.city || '',
                        "state": property.state || '',
                        "zip": property.zip || '',
                        "county": property.county || 'Unknown',
                        "operator": property.operator || '',
                        "well_name": property.well_name || '',
                        "property_description": property.property_description || '',
                        "formatted_address": formatAddress(property)
                    }
                }))
        };
    }

    function addDataToMap() {
        const geojsonData = convertToGeoJSON(propertyData);

        // Add county boundaries source
        map.addSource('counties', {
            'type': 'vector',
            'url': 'mapbox://mapbox.boundaries-adm2-v3'
        });

        console.log('Added county boundaries source');

        // Add source
        map.addSource('properties', {
            'type': 'geojson',
            'data': geojsonData
        });

        // Add county boundaries layer - make it very visible for debugging
        map.addLayer({
            'id': 'county-boundaries',
            'type': 'line',
            'source': 'counties',
            'source-layer': 'boundaries_admin_2',
            'filter': ['==', 'iso_3166_1', 'US'],
            'paint': {
                'line-color': '#ff0000',  // Bright red for visibility
                'line-width': 3,          // Thicker lines
                'line-opacity': 1         // Full opacity
            }
        });

        console.log('Added county boundaries layer');

        // Check if the layer was added successfully
        setTimeout(() => {
            const features = map.querySourceFeatures('counties', {
                sourceLayer: 'boundaries_admin_2',
                filter: ['==', 'iso_3166_1', 'US']
            });
            console.log(`Found ${features.length} county boundary features`);
            if (features.length > 0) {
                console.log('Sample county:', features[0].properties);
            }
        }, 2000);

        // Add circle layer for properties
        map.addLayer({
            'id': 'property-points',
            'type': 'circle',
            'source': 'properties',
            'paint': {
                'circle-radius': 4,
                'circle-color': '#4264fb',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 2
            }
        });

        // Add click event for popups
        map.on('click', 'property-points', (e) => {
            const properties = e.features[0].properties;
            
            const popupContent = `
                <div class="property-popup">
                    <h3>${properties.owner_name}</h3>
                    <div class="property-details">
                        <p><strong>Address:</strong> ${properties.formatted_address}</p>
                        <p><strong>County:</strong> ${properties.county}</p>
                        ${properties.operator ? `<p><strong>Operator:</strong> ${properties.operator}</p>` : ''}
                        ${properties.well_name ? `<p><strong>Well:</strong> ${properties.well_name}</p>` : ''}
                        ${properties.property_description ? `<p class="property-desc"><strong>Description:</strong> ${properties.property_description.substring(0, 100)}${properties.property_description.length > 100 ? '...' : ''}</p>` : ''}
                    </div>
                </div>
            `;

            new mapboxgl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(popupContent)
                .addTo(map);
        });

        // Change cursor on hover and increase radius
        map.on('mouseenter', 'property-points', (e) => {
            map.getCanvas().style.cursor = 'pointer';

            // Highlight the hovered feature
            map.setPaintProperty('property-points', 'circle-radius', [
                'case',
                ['==', ['get', 'owner_name'], e.features[0].properties.owner_name],
                6,
                4
            ]);
        });

        map.on('mouseleave', 'property-points', () => {
            map.getCanvas().style.cursor = '';

            // Reset radius
            map.setPaintProperty('property-points', 'circle-radius', 4);
        });
    }

    function formatAddress(property) {
        const parts = [];
        if (property.owner_address) parts.push(property.owner_address);
        if (property.city) parts.push(property.city);
        if (property.state) parts.push(property.state);
        if (property.zip) parts.push(property.zip);
        return parts.join(', ') || 'Address not available';
    }

    // County filter functionality
    function filterByCounty(county) {
        if (!map.getSource('properties')) return;

        let filteredData;
        if (county === 'all') {
            filteredData = propertyData;
            // Show all of Texas
            map.fitBounds([[-106.65, 25.84], [-93.51, 36.5]], { padding: 50 });
        } else {
            filteredData = propertyData.filter(property =>
                property.county && property.county.trim() === county
            );
        }

        // Update the source data
        const geojsonData = convertToGeoJSON(filteredData);
        map.getSource('properties').setData(geojsonData);

        // If filtering by specific county, zoom to county boundary
        if (county !== 'all') {
            // Query county boundary from the boundaries source
            const countyFeatures = map.querySourceFeatures('counties', {
                sourceLayer: 'boundaries_admin_2',
                filter: ['all',
                    ['==', 'iso_3166_1', 'US'],
                    ['==', 'name', county]
                ]
            });

            if (countyFeatures.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                const geometry = countyFeatures[0].geometry;

                // Handle different geometry types
                if (geometry.type === 'Polygon') {
                    geometry.coordinates[0].forEach(coord => {
                        bounds.extend(coord);
                    });
                } else if (geometry.type === 'MultiPolygon') {
                    geometry.coordinates.forEach(polygon => {
                        polygon[0].forEach(coord => {
                            bounds.extend(coord);
                        });
                    });
                }

                map.fitBounds(bounds, { padding: 50 });
            } else {
                // Fallback: zoom to property points if county boundary not found
                if (geojsonData.features.length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    geojsonData.features.forEach(feature => {
                        bounds.extend(feature.geometry.coordinates);
                    });
                    map.fitBounds(bounds, { padding: 50 });
                }
            }
        }
    }

    // Load data when page loads
    map.on('load', () => {
        loadPropertyData();
    });
  
    // Add search functionality
    window.addEventListener('load', () => {
        const searchBox = new MapboxSearchBox();
        searchBox.accessToken = ACCESS_TOKEN;
        searchBox.marker = true;
        searchBox.mapboxgl = mapboxgl;
        searchBox.componentOptions = { allowReverse: true, flipCoordinates: true };
        map.addControl(searchBox);
    });

</script>

</body>
</html>